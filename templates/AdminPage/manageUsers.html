{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Users | RUPP Admin Panel</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAQAABILAAASCwAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'AdminPage/css/manageRooms.css' %}">
    <link rel="stylesheet" href="{% static 'AdminPage/css/disable-bulk-actions.css' %}">
</head>
<body data-page="user-management" data-url="{{ request.path }}">>
    <!-- Header -->
    {% include 'AdminPage/includes/admin_header.html' %}

    <!-- Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h2>User Management</h2>
                <p class="text-muted">Manage all system users and their roles</p>
            </div>
        </div>

        <!-- User Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ total_users }}</h4>
                                <small>Total Users</small>
                            </div>
                            <div>
                                <i class="fas fa-users fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ active_users }}</h4>
                                <small>Active Users</small>
                            </div>
                            <div>
                                <i class="fas fa-user-check fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ admin_count }}</h4>
                                <small>Administrators</small>
                            </div>
                            <div>
                                <i class="fas fa-user-shield fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h4>{{ user_count }}</h4>
                                <small>Regular Users</small>
                            </div>
                            <div>
                                <i class="fas fa-user fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- User Search and Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
                    <button class="btn btn-outline-secondary" type="button">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="roleFilter">
                    <option value="">All Roles</option>
                    <option value="Admin">Administrators</option>
                    <option value="User">Regular Users</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">All Status</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <!-- Users Table -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>All Users</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped" id="usersTable">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Faculty</th>
                                        <th>Department</th>
                                        <th>Date Joined</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_item in all_users %}
                                    <tr data-role="{% if user_item.is_admin %}Admin{% else %}User{% endif %}" 
                                        data-status="{% if user_item.is_active %}active{% else %}inactive{% endif %}">
                                        <td>{{ user_item.first_name }} {{ user_item.last_name }}</td>
                                        <td>{{ user_item.email }}</td>
                                        <td>
                                            {% if user_item.is_admin %}
                                                <span class="badge bg-danger">Admin</span>
                                            {% else %}
                                                <span class="badge bg-primary">User</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if user_item.is_active %}
                                                <span class="badge bg-success">Active</span>
                                            {% else %}
                                                <span class="badge bg-danger">Inactive</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ user_item.faculty|default:"N/A" }}</td>
                                        <td>{{ user_item.department|default:"N/A" }}</td>
                                        <td>{{ user_item.date_joined|date:"M d, Y" }}</td>
                                        <td>
                                            {% if user_item.id != user.id %}
                                                <div class="btn-group" role="group">
                                                    {% if user_item.is_active %}
                                                        <button class="btn btn-sm btn-outline-danger" 
                                                                onclick="toggleStatusAjax({{ user_item.id }}, 'toggle_active', '{{ user_item.first_name }} {{ user_item.last_name }}', true)">
                                                            <i class="fas fa-user-slash"></i> Deactivate
                                                        </button>
                                                    {% else %}
                                                        <button class="btn btn-sm btn-outline-success" 
                                                                onclick="toggleStatusAjax({{ user_item.id }}, 'toggle_active', '{{ user_item.first_name }} {{ user_item.last_name }}', false)">
                                                            <i class="fas fa-user-check"></i> Activate
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="badge bg-info">Current User</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center">No users found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modals -->
    <div class="modal fade" id="roleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change User Role</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="role_action">
                    <input type="hidden" name="user_id" id="role_user_id">
                    <div class="modal-body">
                        <p id="role_message">Are you sure you want to change this user's role?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change User Status</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" id="status_action">
                    <input type="hidden" name="user_id" id="status_user_id">
                    <div class="modal-body">
                        <p id="status_message">Are you sure you want to change this user's status?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-warning">Confirm</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>All Rights Reserved, Copyright Â© 2025 Royal University of Phnom Penh (RUPP)</p>
            <p>Russian Federation Boulevard, Toul Kork, Phnom Penh, Cambodia. Tel: 855-972 274 936</p>
            <p>Designed by: DSE TEAM</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="{% static 'AdminPage/js/manageUsers.js' %}?v=2025011"></script>
    
    <!-- Force disable bulk actions -->
    <script>
        // Additional safeguard to remove bulk actions
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                // Force hide bulk action elements
                const bulkElements = document.querySelectorAll(
                    '#bulkActions, .bulk-actions, #selectAll, #selectAllTable, ' +
                    '.user-checkbox, .checkbox-header, #bulkActionSelect, #applyBulkAction'
                );
                bulkElements.forEach(el => {
                    if (el) {
                        el.style.display = 'none';
                        el.remove();
                    }
                });
                
                console.log('Bulk actions forcefully removed from user management page');
            }, 200);
        });
    </script>
    
    <!-- Fallback JS for modal functionality -->
    <script>
        // Fallback functions for modal-based actions (if AJAX fails)
        function changeRole(userId, action) {
            document.getElementById('role_user_id').value = userId;
            document.getElementById('role_action').value = action;
            
            const userName = event.target.closest('tr').cells[0].textContent.trim();
            const message = action === 'make_admin' ? 
                `Are you sure you want to make "${userName}" an administrator?` :
                `Are you sure you want to make "${userName}" a regular user?`;
            
            document.getElementById('role_message').textContent = message;
            
            var modal = new bootstrap.Modal(document.getElementById('roleModal'));
            modal.show();
        }

        function toggleStatus(userId, action) {
            document.getElementById('status_user_id').value = userId;
            document.getElementById('status_action').value = action;
            
            const userName = event.target.closest('tr').cells[0].textContent.trim();
            document.getElementById('status_message').textContent = 
                `Are you sure you want to change "${userName}"'s status?`;
            
            var modal = new bootstrap.Modal(document.getElementById('statusModal'));
            modal.show();
        }

        // Enhanced filter functionality (fallback)
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('userSearch');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');
            const tableRows = document.querySelectorAll('#usersTable tbody tr');

            function filterUsers() {
                const searchTerm = searchInput.value.toLowerCase();
                const selectedRole = roleFilter.value;
                const selectedStatus = statusFilter.value;

                tableRows.forEach(row => {
                    const userName = row.cells[0].textContent.toLowerCase();
                    const userEmail = row.cells[1].textContent.toLowerCase();
                    const userRole = row.getAttribute('data-role');
                    const userStatus = row.getAttribute('data-status');

                    const matchesSearch = userName.includes(searchTerm) || userEmail.includes(searchTerm);
                    const matchesRole = !selectedRole || userRole === selectedRole;
                    const matchesStatus = !selectedStatus || userStatus === selectedStatus;

                    if (matchesSearch && matchesRole && matchesStatus) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }

            searchInput.addEventListener('input', filterUsers);
            roleFilter.addEventListener('change', filterUsers);
            statusFilter.addEventListener('change', filterUsers);
        });
    </script>
</body>
</html>
