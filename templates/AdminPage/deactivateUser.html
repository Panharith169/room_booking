{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deactivate User | RUPP Room Booking System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'AdminPage/css/adminHomePage.css' %}">
    <link rel="stylesheet" href="{% static 'AdminPage/css/manageRooms.css' %}">
    <link rel="stylesheet" href="{% static 'AdminPage/css/makeAdmin.css' %}">
</head>
<body>
    <!-- Header -->
    {% include 'AdminPage/includes/admin_header.html' %}

    <!-- Messages -->
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Main Content -->
    <div class="container">
        <div class="page-header">
            <h1><i class="fas fa-user-slash"></i> Deactivate User Account</h1>
            <p>Manage user account access to the system</p>
        </div>

        <!-- Deactivate Users Card -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h3><i class="fas fa-user-slash"></i> Deactivate User</h3>
            </div>
            <div class="card-body">
                <form method="post" class="admin-form" id="deactivateForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="deactivate">
                    
                    <div class="form-group">
                        <label for="deactivate_user_email">Select User to Deactivate</label>
                        <select class="form-control" id="deactivate_user_email" name="user_email" required>
                            <option value="">Select a user to deactivate...</option>
                            {% for user_item in active_users %}
                                <option value="{{ user_item.email }}" 
                                        {% if user_item.email == selected_user_email %}selected{% endif %}>
                                    {{ user_item.first_name }} {{ user_item.last_name }} ({{ user_item.email }})
                                    {% if user_item.is_admin %} - Admin{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>User Information</label>
                        <div id="deactivateUserInfo" class="user-info-display">
                            <p class="text-muted">Select a user to view their information</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <strong>Warning:</strong> Deactivating a user will prevent them from logging in and accessing the system. 
                            Their bookings will remain in the system but they won't be able to create new ones.
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-user-slash"></i> Deactivate User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Activate Users Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h3><i class="fas fa-user-check"></i> Activate User</h3>
            </div>
            <div class="card-body">
                <form method="post" class="admin-form" id="activateForm">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="activate">
                    
                    <div class="form-group">
                        <label for="activate_user_email">Select User to Activate</label>
                        <select class="form-control" id="activate_user_email" name="user_email" required>
                            <option value="">Select a user to activate...</option>
                            {% for user_item in inactive_users %}
                                <option value="{{ user_item.email }}">
                                    {{ user_item.first_name }} {{ user_item.last_name }} ({{ user_item.email }})
                                    {% if user_item.is_admin %} - Admin{% endif %}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>User Information</label>
                        <div id="activateUserInfo" class="user-info-display">
                            <p class="text-muted">Select a user to view their information</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Info:</strong> Activating a user will restore their access to the system. 
                            They will be able to log in and use all features according to their role.
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-check"></i> Activate User
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Navigation -->
        <div class="card">
            <div class="card-body text-center">
                <a href="{% url 'accounts:admin_dashboard' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-home"></i> Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Current Status Overview -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h4><i class="fas fa-users"></i> Active Users ({{ active_users.count }})</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_item in active_users|slice:":10" %}
                                        <tr>
                                            <td>{{ user_item.first_name }} {{ user_item.last_name }}</td>
                                            <td>{{ user_item.email }}</td>
                                            <td>
                                                {% if user_item.is_admin %}
                                                    <span class="badge bg-primary">Admin</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">User</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center">No active users found.</td>
                                        </tr>
                                    {% endfor %}
                                    {% if active_users.count > 10 %}
                                        <tr>
                                            <td colspan="3" class="text-center">
                                                <small class="text-muted">And {{ active_users.count|add:"-10" }} more...</small>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h4><i class="fas fa-user-slash"></i> Inactive Users ({{ inactive_users.count }})</h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for user_item in inactive_users|slice:":10" %}
                                        <tr>
                                            <td>{{ user_item.first_name }} {{ user_item.last_name }}</td>
                                            <td>{{ user_item.email }}</td>
                                            <td>
                                                {% if user_item.is_admin %}
                                                    <span class="badge bg-primary">Admin</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">User</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="3" class="text-center">No inactive users found.</td>
                                        </tr>
                                    {% endfor %}
                                    {% if inactive_users.count > 10 %}
                                        <tr>
                                            <td colspan="3" class="text-center">
                                                <small class="text-muted">And {{ inactive_users.count|add:"-10" }} more...</small>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // User data for display
        const activeUsers = {
            {% for user_item in active_users %}
                "{{ user_item.email }}": {
                    "name": "{{ user_item.first_name }} {{ user_item.last_name }}",
                    "email": "{{ user_item.email }}",
                    "faculty": "{{ user_item.faculty|default:'Not specified' }}",
                    "department": "{{ user_item.department|default:'Not specified' }}",
                    "student_id": "{{ user_item.student_id|default:'Not specified' }}",
                    "phone": "{{ user_item.phone_number|default:'Not specified' }}",
                    "joined": "{{ user_item.date_joined|date:'M d, Y' }}",
                    "is_admin": {{ user_item.is_admin|yesno:"true,false" }}
                },
            {% endfor %}
        };

        const inactiveUsers = {
            {% for user_item in inactive_users %}
                "{{ user_item.email }}": {
                    "name": "{{ user_item.first_name }} {{ user_item.last_name }}",
                    "email": "{{ user_item.email }}",
                    "faculty": "{{ user_item.faculty|default:'Not specified' }}",
                    "department": "{{ user_item.department|default:'Not specified' }}",
                    "student_id": "{{ user_item.student_id|default:'Not specified' }}",
                    "phone": "{{ user_item.phone_number|default:'Not specified' }}",
                    "joined": "{{ user_item.date_joined|date:'M d, Y' }}",
                    "is_admin": {{ user_item.is_admin|yesno:"true,false" }}
                },
            {% endfor %}
        };

        // Event listeners for user selection
        document.getElementById('deactivate_user_email').addEventListener('change', function() {
            showUserInfo(this.value, 'deactivateUserInfo', activeUsers);
        });

        document.getElementById('activate_user_email').addEventListener('change', function() {
            showUserInfo(this.value, 'activateUserInfo', inactiveUsers);
        });

        function showUserInfo(email, targetId, userList) {
            const userInfo = document.getElementById(targetId);
            
            if (email && userList[email]) {
                const user = userList[email];
                const roleText = user.is_admin ? '<span class="badge bg-primary">Admin</span>' : '<span class="badge bg-secondary">User</span>';
                
                userInfo.innerHTML = `
                    <div class="user-details">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> ${user.name}</p>
                                <p><strong>Email:</strong> ${user.email}</p>
                                <p><strong>Student ID:</strong> ${user.student_id}</p>
                                <p><strong>Role:</strong> ${roleText}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Faculty:</strong> ${user.faculty}</p>
                                <p><strong>Department:</strong> ${user.department}</p>
                                <p><strong>Phone:</strong> ${user.phone}</p>
                                <p><strong>Member Since:</strong> ${user.joined}</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                userInfo.innerHTML = '<p class="text-muted">Select a user to view their information</p>';
            }
        }

        // Show user info on page load if user is pre-selected
        document.addEventListener('DOMContentLoaded', function() {
            const selectedEmail = "{{ selected_user_email }}";
            if (selectedEmail) {
                const deactivateSelect = document.getElementById('deactivate_user_email');
                const activateSelect = document.getElementById('activate_user_email');
                
                if (deactivateSelect.value === selectedEmail) {
                    showUserInfo(selectedEmail, 'deactivateUserInfo', activeUsers);
                } else if (activateSelect.value === selectedEmail) {
                    showUserInfo(selectedEmail, 'activateUserInfo', inactiveUsers);
                }
            }
        });

        // Confirmation dialogs
        document.getElementById('deactivateForm').addEventListener('submit', function(e) {
            const email = document.getElementById('deactivate_user_email').value;
            if (email && activeUsers[email]) {
                const user = activeUsers[email];
                const confirmed = confirm(`Are you sure you want to deactivate ${user.name}? They will not be able to log in until reactivated.`);
                if (!confirmed) {
                    e.preventDefault();
                }
            }
        });

        document.getElementById('activateForm').addEventListener('submit', function(e) {
            const email = document.getElementById('activate_user_email').value;
            if (email && inactiveUsers[email]) {
                const user = inactiveUsers[email];
                const confirmed = confirm(`Are you sure you want to activate ${user.name}? They will regain access to the system.`);
                if (!confirmed) {
                    e.preventDefault();
                }
            }
        });
    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>All Rights Reserved, Copyright © 2025 Royal University of Phnom Penh (RUPP)</p>
            <p>Russian Federation Boulevard, Toul Kork, Phnom Penh, Cambodia. Tel: 855-972 274 936</p>
            <p>Designed by: DSE TEAM</p>
        </div>
    </footer>
</body>
</html>
